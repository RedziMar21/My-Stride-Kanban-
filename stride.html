<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stride Kanban Board</title>
  <link rel="icon" href="stride_favicon.svg" type="image/svg+xml">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/helpers.esm.min.js"></script>

  <style>
    :root {
      --color-bg-page-start: #FFFFFF;
      --color-bg-page-end: #F0F4F1;
      --color-text-primary: #2D3748;
      --color-text-secondary: #718096;
      --color-text-muted: #A0AEC0;
      --color-accent: #7FB34C;
      --color-accent-rgb: 127, 179, 76;
      --color-accent-hover: #67913D;
      --color-bg-page-start-rgb: 255, 255, 255;
      --color-bg-page-end-rgb: 240, 244, 241;
      --bg-image-url: url('2.png');
      
      --color-ui-bg-light: rgba(255, 255, 255, 0.8);
      --color-ui-bg-medium: rgba(255, 255, 255, 0.7);
      --color-ui-border: rgba(200, 210, 205, 0.6);
      --color-ui-shadow: rgba(0, 0, 0, 0.06);
      --color-ui-shadow-hover: rgba(0, 0, 0, 0.12);
      --color-card-bg: rgba(255, 255, 255, 0.9);
      --color-card-border: rgba(220, 230, 225, 0.8);
      --color-priority-low: #48BB78;
      --color-priority-medium: #ED8936;
      --color-priority-high: #E53E3E;
      --color-overdue-text: #E53E3E;
      --color-upcoming-text: #D69E2E;
      --color-normal-date-text: var(--color-text-muted);
      --color-warning-bg: #fefcbf;
      --color-warning-text: #744210;
      --color-warning-border: #fde68a;
    }

    body.dark-mode {
      --color-bg-page-start: #1E2621;
      --color-bg-page-end: #101714;
      --color-text-primary: #EAE7E3;
      --color-text-secondary: #A0AEC0;
      --color-text-muted: #718096;
      --color-bg-page-start-rgb: 30, 38, 33;
      --color-bg-page-end-rgb: 16, 23, 20;
      --bg-image-url: url('4.png');
      
      --color-ui-bg-light: rgba(45, 66, 59, 0.7);
      --color-ui-bg-medium: rgba(45, 66, 59, 0.5);
      --color-ui-border: rgba(70, 96, 86, 0.5);
      --color-ui-shadow: rgba(0, 0, 0, 0.18);
      --color-ui-shadow-hover: rgba(0, 0, 0, 0.3);
      --color-card-bg: rgba(45, 66, 59, 0.9);
      --color-card-border: rgba(70, 96, 86, 0.7);
      --color-priority-low: #68D391;
      --color-priority-medium: #F6AD55;
      --color-priority-high: #FC8181;
      --color-overdue-text: #FC8181;
      --color-upcoming-text: #F6E05E;
      --color-warning-bg: #4A5568;
      --color-warning-text: #F6E05E;
      --color-warning-border: #ECC94B;
    }

    body {
      font-family: 'Inter', sans-serif;
      color: var(--color-text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding-bottom: 5rem;
      box-sizing: border-box;
      background-image: linear-gradient(to bottom right, rgba(var(--color-bg-page-start-rgb), 0.85), rgba(var(--color-bg-page-end-rgb), 0.95)), var(--bg-image-url);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      overflow-x: hidden;
    }

    h1, h2, h3, h4, h5, h6, .font-poppins {
      font-family: 'Poppins', sans-serif;
    }

    #landing-view .landing-header h1,
    #kanban-view-header .app-title,
    #onboarding-view .onboarding-header h2,
    .auth-top-logo-container {
        display: flex;
        align-items: baseline; 
    }

    .inline-logo-img { 
        height: 1.0em; 
        width: auto;
        stroke: var(--color-accent);
        fill: none; 
        margin-right: 0.3em; 
        transform: translateY(-0.05em); 
    }
    .auth-top-logo { 
        position: absolute;
        top: 1.5rem;
        left: 1.5rem;
        height: 32px;
        width: auto;
        stroke: var(--color-accent);
        fill: none;
        z-index: 10;
    }


    .glass {
      background: var(--color-ui-bg-light);
      border: 1px solid var(--color-ui-border);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 1.5rem;
      box-shadow: 0 4px 12px var(--color-ui-shadow);
    }

    .kanban-column-wrapper {
      padding: 1.5rem;
      border-radius: 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 450px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      flex: 1;
      margin: 0 0.75rem;
      border: 1px solid var(--color-ui-border);
      background-color: var(--color-ui-bg-medium);
      max-width: 400px;
      box-shadow: 0 2px 8px var(--color-ui-shadow);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .kanban-column-wrapper:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 20px var(--color-ui-shadow-hover);
    }

    .tasks-container {
      min-height: 100px;
      flex-grow: 1;
      padding: 1rem;
      margin-top: 1.2rem;
      padding-bottom: 1.5rem;
      position: relative; 
    }
    
    .empty-column-message {
    }


    .task-card {
      padding: 1.25rem;
      border-radius: 0.85rem;
      position: relative;
      box-shadow: 0 1px 5px var(--color-ui-shadow);
      cursor: pointer;
      transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out, border-color 0.2s ease-in-out, opacity 0.3s ease-out, max-height 0.3s ease-out; 
      background-color: var(--color-card-bg);
      border: 1px solid var(--color-card-border);
      color: var(--color-text-primary);
      margin-bottom: 1.2rem;
      border-left: 6px solid var(--color-card-border);
      font-size: 0.98rem;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      animation: fadeIn 0.4s ease-out;
    }
    .task-card.hidden-by-filter { 
        opacity: 0; max-height: 0; padding-top: 0; padding-bottom: 0;
        margin-bottom: 0; overflow: hidden; border-width: 0; 
    }
    .task-card.priority-low { border-left-color: var(--color-priority-low); }
    .task-card.priority-medium { border-left-color: var(--color-priority-medium); }
    .task-card.priority-high { border-left-color: var(--color-priority-high); }
    .task-card:last-child:not(.hidden-by-filter) { margin-bottom: 0; }
    .task-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 14px var(--color-ui-shadow-hover);
      border-color: var(--color-ui-border);
    }
    .task-card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 10px rgba(var(--color-accent-rgb), 0.3);
    }

    .dragging {
      opacity: 0.8; outline: 2px dashed var(--color-accent); outline-offset: 8px;
      transform: scale(1.03) !important; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    .tasks-container.drag-over {
      background-color: rgba(var(--color-accent-rgb), 0.08);
      border-radius: 1rem; border: 2px dashed var(--color-accent);
    }

    .task-actions {
      position: absolute; top: 0.8rem; right: 0.8rem;
      display: flex; gap: 0.5rem; z-index: 10;
    }
    .task-actions button {
      opacity: 0; transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      color: var(--color-text-muted); font-size: 1rem; line-height: 1; padding: 0.3rem;
      border-radius: 0.4rem; background: none; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .task-card:hover .task-actions button { opacity: 0.8; }
    .task-actions button:hover { opacity: 1; color: var(--color-accent); transform: scale(1.1); }
    .delete-btn:hover { color: var(--color-priority-high); }

    .tasks-container::-webkit-scrollbar { width: 8px; }
    .tasks-container::-webkit-scrollbar-track { background: rgba(var(--color-accent-rgb), 0.05); border-radius: 1rem; }
    body.dark-mode .tasks-container::-webkit-scrollbar-track { background: rgba(var(--color-accent-rgb), 0.1); }
    .tasks-container::-webkit-scrollbar-thumb {
      background: rgba(var(--color-accent-rgb), 0.3); border-radius: 1rem;
      border: 2px solid transparent; background-clip: padding-box;
    }
    body.dark-mode .tasks-container::-webkit-scrollbar-thumb { background: rgba(var(--color-accent-rgb), 0.4); }
    .tasks-container::-webkit-scrollbar-thumb:hover { background: rgba(var(--color-accent-rgb), 0.5); }
    body.dark-mode .tasks-container::-webkit-scrollbar-thumb:hover { background: rgba(var(--color-accent-rgb), 0.6); }

    .column-header-title {
      font-weight: 600; color: var(--color-text-primary); display: flex;
      align-items: center; font-size: 1.55rem; margin-bottom: 0.75rem;
    }
    .column-header-title span.task-count {
      font-size: 0.95rem; font-weight: 400;
      margin-left: 0.7rem; color: var(--color-text-secondary);
    }
    .column-header-title .icon {
      margin-right: 1.2rem; width: 2.0rem;
      height: 2.0rem; color: var(--color-accent);
    }
    
    .btn { 
      white-space: nowrap;
      font-weight: 500;
      border-radius: 0.85rem;
      transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out, filter 0.2s ease-in-out;
      padding: 1rem 2.5rem;
      box-shadow: 0 2px 8px var(--color-ui-shadow);
      border: 1px solid transparent;
      font-size: 1.05rem;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      display: inline-flex; 
      align-items: center;
      justify-content: center;
    }
    .btn-primary-accent {
      background-color: var(--color-accent);
      color: white;
    }
    .btn-primary-accent:hover {
      background-color: var(--color-accent-hover);
      transform: translateY(-4px);
      box-shadow: 0 6px 16px var(--color-ui-shadow-hover);
    }
    .btn-primary-accent:active {
      transform: scale(0.96) translateY(-2px);
      box-shadow: 0 1px 4px var(--color-ui-shadow);
      filter: brightness(0.95);
    }
    .btn-secondary {
      background-color: var(--color-ui-bg-light);
      color: var(--color-text-primary);
      border-color: var(--color-ui-border);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .btn-secondary:hover {
      background-color: rgba(var(--color-accent-rgb), 0.15);
      border-color: var(--color-accent);
      transform: translateY(-4px);
      box-shadow: 0 6px 16px var(--color-ui-shadow-hover);
      color: var(--color-accent);
    }
    body.dark-mode .btn-secondary:hover {
      background-color: rgba(var(--color-accent-rgb), 0.1);
      color: var(--color-accent);
    }
    .btn-secondary:active {
      transform: scale(0.96) translateY(-2px);
      box-shadow: 0 1px 4px var(--color-ui-shadow);
      filter: brightness(0.95);
    }
    .btn-neutral { 
      background-color: var(--color-text-muted);
      color: white;
    }
    .btn-neutral:hover {
      background-color: var(--color-text-secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px var(--color-ui-shadow);
    }
    .btn-sm { 
        padding: 0.5rem 1rem;
        font-size: 0.875rem; 
    }

    .input-field-custom {
      width: 100%; border-radius: 0.85rem;
      transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
      background-color: var(--color-ui-bg-light); border: 1px solid var(--color-ui-border);
      color: var(--color-text-primary); padding: 1rem 1.5rem; 
      box-shadow: inset 0 1px 3px var(--color-ui-shadow); font-size: 1.05rem;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    .input-field-custom.pr-10 { padding-right: 2.5rem; }
    .input-field-custom::placeholder { color: var(--color-text-muted); opacity: 1; }
    .input-field-custom:focus {
      outline: none; border-color: var(--color-accent);
      box-shadow: 0 0 0 4px rgba(var(--color-accent-rgb), 0.25), inset 0 1px 3px var(--color-ui-shadow);
      background-color: var(--color-card-bg);
    }

    .error-message {
      color: var(--color-warning-text); font-size: 0.9rem; margin-top: 0.5rem;
      background-color: var(--color-warning-bg); padding: 0.6rem 1rem;
      border-radius: 0.65rem; border: 1px solid var(--color-warning-border);
      opacity: 1; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
      text-align: center;
    }

    .task-description {
      color: var(--color-text-primary); font-size: 0.98rem; line-height: 1.6;
      margin-top: 0; word-break: break-word; padding-right: 3rem;
      transition: padding-right 0.2s ease-in-out;
    }
    
    .task-meta {
      font-size: 0.88rem; color: var(--color-text-secondary); display: flex;
      flex-direction: column; gap: 0.6rem; max-height: 0; overflow: hidden;
      opacity: 0; margin-top: 0;
      transition: max-height 0.4s ease-out, opacity 0.3s ease-out, margin-top 0.4s ease-out;
      pointer-events: none; padding-top: 0.7rem; border-top: 1px solid var(--color-ui-border);
    }
    .task-meta > span { display: flex; align-items: flex-start; }
    .task-meta > span > i, .task-labels-container > i.fa-tags {
      color: var(--color-text-muted); margin-right: 0.5rem; flex-shrink: 0;
      margin-top: 0.1em; font-size: 0.9em; 
    }
    .task-meta i.fa-exclamation-circle { color: var(--color-priority-high); }
    .task-meta i.fa-clock { color: var(--color-upcoming-text); }

    .task-card.expanded .task-meta {
      max-height: 300px; opacity: 1; margin-top: 0.75rem;
      transition: max-height 0.4s ease-in, opacity 0.3s ease-in, margin-top 0.4s ease-in;
      pointer-events: auto;
    }
    
    .task-labels-container { align-items: flex-start; flex-wrap: wrap; gap: 0.3rem 0.4rem; }
    .task-label-badge {
      background-color: rgba(var(--color-accent-rgb), 0.12); color: var(--color-accent);
      padding: 0.2rem 0.6rem; border-radius: 0.85rem; font-size: 0.78rem; 
      font-weight: 500; line-height: 1.3; white-space: nowrap;
      border: 1px solid rgba(var(--color-accent-rgb), 0.2);
    }
    body.dark-mode .task-label-badge {
      background-color: rgba(var(--color-accent-rgb), 0.2);
      border-color: rgba(var(--color-accent-rgb), 0.3);
    }

    .task-meta .priority-low-text { color: var(--color-priority-low); }
    .task-meta .priority-medium-text { color: var(--color-priority-medium); }
    .task-meta .priority-high-text { color: var(--color-priority-high); }
    .task-meta .overdue-text { color: var(--color-overdue-text); font-weight: 500; }
    .task-meta .upcoming-text { color: var(--color-upcoming-text); font-weight: 500; }
    .task-meta .normal-date-text { color: var(--color-normal-date-text); }

    .column-header { margin-bottom: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
    .kanban-columns-container {
      display: flex; flex-direction: row; justify-content: center;
      margin: 3rem auto; width: 100%; max-width: 1600px;
      overflow-x: auto; padding-bottom: 2rem; gap: 2rem;
    }
    .kanban-column-wrapper { flex-shrink: 0; flex-basis: 350px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .task-card.removing { animation: fadeOut 0.3s ease-in forwards; }
    @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }

    .task-card .edit-form { display: flex; flex-direction: column; gap: 0.75rem; width: 100%; }
    .task-card .edit-form textarea,
    .task-card .edit-form select,
    .task-card .edit-form input[type="date"],
    .task-card .edit-form input[type="text"] {
      width: 100%; min-height: 80px; padding: 0.6rem; border-radius: 0.4rem;
      border: 1px solid var(--color-card-border); background-color: var(--color-card-bg);
      color: var(--color-text-primary); font-size: 0.9rem; line-height: 1.5;
      resize: vertical; font-family: 'Inter', sans-serif;
      backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
    }
    .task-card .edit-form textarea:focus,
    .task-card .edit-form select:focus,
    .task-card .edit-form input[type="date"]:focus,
    .task-card .edit-form input[type="text"]:focus {
      outline: none; border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(var(--color-accent-rgb), 0.15);
    }
    .task-card .edit-form .edit-buttons { display: flex; justify-content: flex-end; gap: 0.6rem; }
    .task-card-action-btn { 
      font-size: 0.85rem; padding: 0.5rem 1rem; border-radius: 0.5rem; opacity: 1;
      color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease, transform 0.15s ease, filter 0.15s ease;
      border: none; cursor: pointer;
    }
    .task-card-action-btn:hover { transform: translateY(-2px); }
    .task-card-action-btn:active { transform: scale(0.97) translateY(-1px); filter: brightness(0.95); }

    .task-card .edit-form .edit-buttons .save-btn { background-color: var(--color-accent); }
    .task-card .edit-form .edit-buttons .save-btn:hover { background-color: var(--color-accent-hover); }
    .task-card .edit-form .edit-buttons .cancel-btn { background-color: var(--color-text-muted); }
    .task-card .edit-form .edit-buttons .cancel-btn:hover { background-color: var(--color-text-secondary); }

    .task-card .edit-form { display: none; }
    .task-card.editing .task-content-view,
    .task-card.editing .task-actions .edit-btn,
    .task-card.editing .task-actions .delete-btn { display: none !important; }
    .task-card.editing .edit-form { display: flex; }

    .theme-toggle-container {
      position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1000;
      display: flex; gap: 0.75rem; align-items: center;
    }
    .theme-toggle-button.glass {
      border-radius: 50%; width: 48px; height: 48px; display: flex;
      align-items: center; justify-content: center; cursor: pointer;
      transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
    }
    .theme-toggle-button.glass:hover {
      transform: scale(1.1); background: rgba(var(--color-bg-page-start-rgb), 0.95);
      box-shadow: 0 4px 12px var(--color-ui-shadow-hover);
    }
    body.dark-mode .theme-toggle-button.glass:hover { background: rgba(var(--color-bg-page-start-rgb), 0.9); }
    .theme-toggle-button svg { width: 26px; height: 26px; color: var(--color-text-primary); transition: color 0.3s ease; }

    .progress-container {
      width: 100%; max-width: 1600px; margin: 2.5rem auto 2rem auto;
      padding: 0 1.5rem; box-sizing: border-box;
    }
    .progress-bar {
      height: 30px; background-color: var(--color-ui-bg-light); border: 1px solid var(--color-ui-border);
      border-radius: 1rem; overflow: hidden; position: relative;
      box-shadow: inset 0 1px 4px var(--color-ui-shadow); display: flex;
      align-items: center; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    }
    .progress-fill {
      height: 100%; width: 0%;
      background: linear-gradient(to right, var(--color-accent), var(--color-accent-hover));
      transition: width 0.5s ease-in-out; position: absolute; top: 0; left: 0;
      border-radius: 1rem 0 0 1rem;
    }
    .progress-text {
      position: absolute; width: 100%; text-align: center; font-weight: 600;
      color: white; mix-blend-mode: difference;
      text-shadow: 0 1px 1px rgba(0,0,0,0.3), 0 0 3px rgba(0,0,0,0.2);
      font-size: 1rem; pointer-events: none;
    }
    body.dark-mode .progress-text {
      color: var(--color-text-primary); mix-blend-mode: unset;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    body.dark-mode .progress-fill { background: linear-gradient(to right, var(--color-accent-hover), var(--color-accent)); }

    .export-buttons {
      width: 100%; max-width: 700px; margin: 2rem auto; display: flex;
      gap: 1.5rem; justify-content: center; flex-wrap: wrap;
    }
    .export-buttons .btn-secondary { padding: 0.9rem 2rem; } 

    .view-hidden { display: none !important; }
    #landing-view, #login-view, #register-view, #kanban-view, #onboarding-view {
      opacity: 0; transform: translateY(20px); 
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      will-change: opacity, transform; 
    }
    #landing-view:not(.view-hidden), #login-view:not(.view-hidden),
    #register-view:not(.view-hidden), #kanban-view:not(.view-hidden), 
    #onboarding-view:not(.view-hidden) { 
      opacity: 1; transform: translateY(0px);
    }
    
    /* AUTH PAGE LAYOUT ADJUSTMENTS */
    #login-view, #register-view {
        display: flex; 
        flex-direction: column;
        align-items: center;
        justify-content: center; 
        min-height: calc(100vh - 5rem); 
        padding-top: 2rem; 
        position: relative; 
    }
    #login-view .auth-welcome-header {
        text-align: center;
        margin-bottom: 2rem; 
    }
    #login-view .auth-welcome-header h1 {
        font-size: 2.8rem; 
        font-weight: 600;
        color: var(--color-text-primary);
        font-family: 'Poppins', sans-serif;
    }
     @media (max-width: 640px) {
        #login-view .auth-welcome-header h1 { font-size: 2.2rem; }
     }


    .auth-form-container { 
        max-width: 500px; 
        width: 90%; 
        margin: 0 auto; 
    }
    #login-view .auth-form-container {
       margin-top: 0; 
    }

    .auth-form-container h2 { text-align: center; font-size: 2rem; margin-bottom: 2.5rem; }
    .auth-form-container .input-field-custom { margin-bottom: 1.5rem; }
    .auth-form-container .password-wrapper { position: relative; margin-bottom: 1.5rem; }
    .auth-form-container .password-wrapper .input-field-custom { margin-bottom: 0; }
    .toggle-password-visibility {
      position: absolute; top: 0; bottom: 0; right: 0; padding-right: 0.75rem;
      display: flex; align-items: center; background: transparent;
      border: none; cursor: pointer; color: var(--color-text-muted);
    }
    .toggle-password-visibility:hover { color: var(--color-accent); }
    .toggle-password-visibility i { font-size: 1rem; }
    .auth-form-container .btn-primary-accent { width: 100%; margin-top: 0.5rem; }
    .auth-switch-link {
      display: block; text-align: center; margin-top: 1.5rem;
      color: var(--color-text-secondary); text-decoration: none; font-size: 0.95rem;
    }
    .auth-switch-link.small-text { font-size: 0.85rem; margin-top: 0.75rem; }
    .auth-switch-link:hover { color: var(--color-accent); text-decoration: underline; }

    #landing-view { padding-bottom: 8rem; }
    #landing-view .landing-header { margin-top: 8rem; margin-bottom: 3rem; justify-content:center; }
    #landing-view .landing-content { max-width: 700px; }
    #landing-view .landing-content h2 { font-size: 1.8rem; margin-bottom: 1rem; }
    #landing-view .landing-content p {
      font-size: 1.1rem; margin-bottom: 2.5rem;
      line-height: 1.7; color: var(--color-text-secondary);
    }
    #landing-view .landing-actions button { margin: 0.5rem; padding: 1rem 2.5rem; font-size: 1.1rem; }

    #landing-features { margin-top: 4rem; padding: 0 1rem; max-width: 1000px; margin-left: auto; margin-right: auto; }
    .feature-item { 
      background: var(--color-ui-bg-light); border: 1px solid var(--color-ui-border);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border-radius: 1.5rem; box-shadow: 0 4px 12px var(--color-ui-shadow);
      padding: 2rem 2.5rem; margin-bottom: 2rem; 
      text-align: left;
      display: flex; flex-direction: column; align-items: center;
      opacity: 0; transform: translateY(40px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .feature-item.active { opacity: 1; transform: translateY(0); }
    .feature-item .feature-icon { 
      font-size: 2.8rem; color: var(--color-accent); margin-bottom: 1.5rem;
      display: inline-block; background: rgba(var(--color-accent-rgb), 0.1);
      padding: 1.2rem; border-radius: 50%; line-height: 1;
    }
    .feature-item h3 { 
      font-family: 'Poppins', sans-serif; font-size: 1.6rem; font-weight: 600;
      margin-bottom: 0.8rem; color: var(--color-text-primary); text-align: center;
    }
    .feature-item p { 
      font-size: 1rem; line-height: 1.65; color: var(--color-text-secondary);
      max-width: 600px; margin-left: auto; margin-right: auto; text-align: center;
    }
    @media (min-width: 768px) {
      .feature-item { flex-direction: row; text-align: left; align-items: flex-start; }
      .feature-item:nth-child(even) { flex-direction: row-reverse; }
      .feature-item .feature-icon { margin-right: 2rem; margin-bottom: 0; margin-left: 0; }
      .feature-item:nth-child(even) .feature-icon { margin-left: 2rem; margin-right: 0; }
      .feature-item .feature-content { flex: 1; }
      .feature-item h3, .feature-item p { text-align: left; }
    }

    #kanban-view-header {
      justify-content: space-between; 
      width: 100%; max-width: 1600px; margin: 2rem auto 0 auto;
      padding: 0 1.5rem; box-sizing: border-box;
    }
    #kanban-view-header .app-title { 
      font-size: 1.75rem; font-weight: 600; font-family: 'Poppins', sans-serif;
      color: var(--color-text-primary);
    }

    #onboarding-view { padding-bottom: 6rem; }
    #onboarding-view .onboarding-header { margin-top: 4rem; margin-bottom: 2rem; justify-content:center; } 
    #onboarding-view .onboarding-content { max-width: 900px; padding-bottom: 3rem; } 
    #onboarding-view .onboarding-content h2 {
      font-size: 2.2rem;
      margin-bottom: 1rem;
      text-align: center;
    }
     #onboarding-view .onboarding-content p.subtitle {
      font-size: 1.1rem;
      margin-bottom: 3rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
      text-align: center;
    }
    #onboarding-view .tutorial-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-top: 2.5rem;
    }
    .tutorial-step {
        margin-bottom: 1rem; 
    }
    .tutorial-step .feature-icon {
        font-size: 2.2rem; 
        padding: 1rem;
    }
     .tutorial-step h3 {
        font-size: 1.3rem;
    }
     .tutorial-step p {
        font-size: 0.95rem;
    }
    #onboarding-view .onboarding-action { margin-top: 3rem; text-align: center; }


    #search-task-container { margin: 1.5rem auto; padding: 0 1.5rem; width: 100%; max-width: 600px; }
    .search-input-wrapper { position: relative; }
    #search-task-input.input-field-custom { width: 100%; padding-left: 3rem; }
    .search-input-wrapper .search-icon {
      position: absolute; left: 1rem; top: 50%; transform: translateY(-50%);
      color: var(--color-text-muted); pointer-events: none; font-size: 1rem; z-index: 5; 
    }
    .global-footer {
      position: fixed; bottom: 0; left: 0; right: 0; padding: 0.75rem;
      text-align: center; font-size: 0.875rem; color: var(--color-text-muted);
      opacity: 0.9; background-color: rgba(var(--color-bg-page-end-rgb), 0.7);
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 900;
    }
    
    @media (max-width: 1280px) { .kanban-column-wrapper { max-width: 380px; flex-basis: 330px; } .kanban-columns-container { gap: 1.5rem; } }
    @media (max-width: 1024px) { .kanban-columns-container { flex-wrap: nowrap; justify-content: flex-start; padding: 0 1.5rem 2rem 1.5rem; } .kanban-column-wrapper { min-width: 320px; margin: 0 0.75rem; flex-basis: 320px; } .column-header-title { font-size: 1.45rem; } .column-header-title .icon { width: 1.8rem; height: 1.8rem; margin-right: 1rem; } .tasks-container { padding: 0.75rem; } .task-card { padding: 1.1rem; } .task-description { padding-right: 2.8rem; } #onboarding-view .onboarding-content h2 {font-size: 1.8rem;} #onboarding-view .tutorial-grid {grid-template-columns: 1fr;} }
    @media (max-width: 768px) { body { padding-bottom: 5rem; } .kanban-columns-container { flex-direction: column; align-items: center; margin: 2rem auto; overflow-x: hidden; gap: 2rem; padding: 0 0 1.5rem 0; } .kanban-column-wrapper { margin: 0; width: 90%; max-width: 500px; min-width: unset; padding: 1.5rem; border-radius: 1.2rem; } .landing-header h1 { font-size: 2.5rem; } .landing-header p { font-size: 0.9rem; } .glass { border-radius: 1.2rem; padding: 1.5rem; margin-bottom: 2rem; } .column-header { margin-bottom: 1rem; } .column-header-title { font-size: 1.3rem; } .column-header-title .icon { width: 1.6rem; height: 1.6rem; margin-right: 0.8rem; } .tasks-container { padding: 0.5rem; margin-top: 0.75rem; } .task-card { padding: 1rem; border-radius: 0.75rem; font-size: 0.9rem; margin-bottom: 0.8rem; border-left-width: 5px; } .task-actions { top: 0.6rem; right: 0.6rem; gap: 0.4rem; } .task-actions button { font-size: 0.9rem; } .task-description { padding-right: 2.5rem; } #add-task-section h2 { font-size: 1.1rem; } .input-field-custom, .btn { padding: 0.8rem 1.2rem; font-size: 0.95rem; border-radius: 0.6rem; } .task-meta { font-size: 0.8rem; gap: 0.5rem; margin-top: 0.6rem; padding-top: 0.4rem; }  .task-meta > span > i, .task-labels-container > i.fa-tags { font-size: 0.9em; margin-right: 0.3rem;} .task-label-badge { font-size: 0.7rem; padding: 0.15rem 0.4rem; } .progress-container { margin: 1.5rem auto; } .export-buttons { flex-direction: column; gap: 0.75rem; padding: 0 1rem; } #landing-features { margin-top: 2rem; } .feature-item { margin-bottom: 2.5rem; } #search-task-container { max-width: 90%; margin-bottom: 1rem; } #search-task-input.input-field-custom { padding-left: 2.75rem; } .search-input-wrapper .search-icon { left: 0.85rem; font-size: 0.9rem; } #charts-section { max-width: 90%; } #charts-section .chart-container {max-height: 300px;} #onboarding-view .onboarding-content h2 { font-size: 1.6rem;} #onboarding-view .onboarding-header { margin-top: 3rem; } .tutorial-step {padding: 1.5rem;} }
    @media (max-width: 480px) { .kanban-column-wrapper { width: 95%; max-width: 350px; padding: 1.2rem; } .landing-header h1 { font-size: 2rem; } .landing-header p { font-size: 0.8rem; } .glass { padding: 1.2rem; margin-bottom: 1.5rem; } .task-card { padding: 0.9rem; border-radius: 0.7rem; font-size: 0.85rem; margin-bottom: 0.7rem; border-left-width: 4px; } .task-description { padding-right: 2.2rem; } .task-actions { top: 0.5rem; right: 0.5rem; gap: 0.3rem; } .task-actions button { font-size: 0.85rem; } .input-field-custom, .btn { padding: 0.7rem 1rem; font-size: 0.9rem; } .column-header-title { font-size: 1.2rem; } .column-header-title .icon { width: 1.5rem; height: 1.5rem; margin-right: 0.6rem; } #search-task-input.input-field-custom { padding-left: 2.5rem; } .search-input-wrapper .search-icon { left: 0.75rem; } .task-meta { font-size: 0.75rem; } .task-label-badge { font-size: 0.65rem; } #charts-section .chart-container {max-height: 250px;} #onboarding-view .onboarding-content h2 { font-size: 1.4rem;} .tutorial-step .feature-icon {font-size: 1.8rem; padding:0.8rem;} .tutorial-step h3 { font-size: 1.1rem;} .tutorial-step p { font-size: 0.9rem;}}

    @media print {
      html, body { width: 100% !important; height: auto !important; overflow: visible !important; background: white !important; color: black !important; margin: 0 !important; padding: 0 !important; font-size: 9pt !important; line-height: 1.2 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      #landing-view, #login-view, #register-view, #onboarding-view, .theme-toggle-container, #kanban-view-header .app-title > svg, #add-task-section, .progress-container, #charts-section, .export-buttons, #search-task-container, footer.global-footer, .empty-column-message, #kanban-view-header > button /* logout */ { display: none !important; }
      #kanban-view-header { display: block !important; text-align: center !important; font-size: 14pt !important; margin-bottom: 1cm !important; padding:0 !important; }
      #kanban-view-header .app-title { font-size: 14pt !important; font-weight: bold !important;}
      #kanban-view { display: block !important; width: 100% !important; margin: 0 !important; padding: 1cm !important; box-sizing: border-box !important; }
      .kanban-columns-container { display: flex !important; flex-direction: row !important; flex-wrap: wrap !important; justify-content: flex-start !important; gap: 10px !important; margin: 0 !important; padding: 0 !important; width: 100% !important; max-width: 100% !important; overflow: visible !important; }
      .kanban-column-wrapper { border: 1px solid #ccc !important; box-shadow: none !important; background-color: #fff !important; padding: 0.5rem !important; margin: 0 !important; flex: 1 1 200px !important; min-width: 180px !important; max-width: 30% !important; break-inside: avoid !important; page-break-inside: avoid !important; min-height: unset !important; height: auto !important; overflow: visible !important; backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
      .kanban-column-wrapper:hover { transform: none !important; }
      .column-header { margin-bottom: 0.5rem !important; }
      .column-header-title { border-bottom: 1px solid #ccc !important; padding-bottom: 0.25rem !important; margin-bottom: 0.5rem !important; color: #333 !important; font-size: 11pt !important; }
      .column-header-title .icon { display: none !important; }
      .column-header-title span.task-count { font-size: 9pt !important; color: #555 !important; }
      .tasks-container { overflow: visible !important; max-height: none !important; min-height: unset !important; padding: 0.25rem !important; margin-top: 0.25rem !important; padding-bottom: 0 !important; }
      .tasks-container>.task-card { margin-bottom: 0.3rem !important; }
      .task-card { box-shadow: none !important; border: 1px solid #e0e0e0 !important; background-color: #fff !important; padding: 0.4rem !important; break-inside: avoid !important; page-break-inside: avoid !important; cursor: auto !important; backdrop-filter: none !important; -webkit-backdrop-filter: none !important; opacity: 1 !important; max-height: none !important; }
      .task-card.priority-low { border-left: 4px solid #48BB78 !important; }
      .task-card.priority-medium { border-left: 4px solid #ED8936 !important; }
      .task-card.priority-high { border-left: 4px solid #E53E3E !important; }
      .task-card:hover { transform: none !important; }
      .task-actions, .edit-form { display: none !important; }
      .task-content-view { display: block !important; }
      .task-description { padding-right: 0 !important; font-size: 8.5pt !important; line-height: 1.2 !important; color: #333 !important; margin-bottom: 0.25rem !important; word-wrap: break-word; overflow-wrap: break-word; }
      .task-meta { color: #555 !important; max-height: none !important; opacity: 1 !important; margin-top: 0.25rem !important; padding-top: 0.25rem !important; border-top: 1px dotted #eee !important; font-size: 7.5pt !important; line-height: 1.1 !important; display: flex !important; flex-direction: column !important; gap: 2px !important; transition: none !important; pointer-events: auto !important; }
      .task-meta > span { display: flex !important; align-items: flex-start !important; margin-bottom: 2px !important; }
      .task-meta > span > i, .task-labels-container > i.fa-tags { color: #666 !important; margin-right: 3px !important; font-size: 0.9em !important; margin-top: 0.05em !important; }
      .task-labels-container { flex-wrap: wrap !important; gap: 2px 3px !important; }
      .task-label-badge { background-color: #eee !important; color: #333 !important; border: 1px solid #ddd !important; padding: 1px 3px !important; font-size: 7pt !important; border-radius: 3px !important;}
      .task-meta .priority-low-text { color: #48BB78 !important; }
      .task-meta .priority-medium-text { color: #ED8936 !important; }
      .task-meta .priority-high-text { color: #E53E3E !important; }
      .task-meta .overdue-text { color: #E53E3E !important; }
      .task-meta .upcoming-text { color: #D69E2E !important; }
      .task-meta .normal-date-text { color: #718096 !important; }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center px-4 sm:px-6 lg:px-8">

  <div class="theme-toggle-container">
    <button id="logout-btn" class="btn btn-secondary btn-sm view-hidden">
        <i class="fas fa-sign-out-alt mr-1"></i>Logout
    </button>
    <button id="theme-toggle" class="theme-toggle-button glass" title="Toggle Theme">
      <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.602-.386l1.591-1.591M3 12h2.25m-.386-6.364l1.591 1.591M12 12a3 3 0 110-6 3 3 0 010 6z" />
      </svg>
      <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.083 3.659 9.334 8.408 10.153h.38c2.49-.402 4.729-1.734 6.333-3.567ZM12 18.75c0-1.036.17-2.05.491-3.002h-7.08a8.25 8.25 0 006.208 6.002v-.002z" />
      </svg>
    </button>
  </div>

  <!-- Landing View -->
  <section id="landing-view" class="w-full text-center view-hidden">
    <header class="landing-header mb-12 mt-16 md:mb-16 text-center w-full max-w-5xl mx-auto">
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-semibold font-poppins uppercase justify-center">
        <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="inline-logo-img sm:mr-3" fill="none">
            <path d="M5 35 L15 25 M15 35 L25 25 M25 35 L35 25" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
        STRIDE
      </h1>
      <p style="color: var(--color-text-secondary);" class="mt-4 text-base sm:text-lg md:text-xl">Build momentum, achieve your goals, seamlessly.</p>
    </header>
    <div class="landing-content glass p-7 md:p-10 rounded-xl shadow-lg w-full max-w-2xl mx-auto">
      <h2 class="font-poppins font-semibold" style="color: var(--color-text-primary);">Welcome to Stride Kanban</h2>
      <p>Organize your projects, track your progress, and visualize your workflow. Stride helps you stay on top of your tasks and build unstoppable momentum.</p>
      <div class="landing-actions mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
        <button id="landing-login-btn" class="btn btn-primary-accent">Login</button>
        <button id="landing-register-btn" class="btn btn-secondary">Get Started</button>
      </div>
    </div>
    <div id="landing-features" class="w-full max-w-4xl mx-auto mt-16 md:mt-24 px-4">
      <div class="feature-item scroll-animate"><span class="feature-icon"><i class="fas fa-columns"></i></span><div class="feature-content"><h3>Visual Workflow</h3><p>Easily visualize your tasks moving through different stages with our intuitive drag-and-drop columns. See your entire project at a glance.</p></div></div>
      <div class="feature-item scroll-animate"><span class="feature-icon"><i class="fas fa-tasks"></i></span><div class="feature-content"><h3>Detailed Task Management</h3><p>Set task priorities, assign due dates, add descriptive labels, and attach notes to keep every detail organized and actionable.</p></div></div>
      <div class="feature-item scroll-animate"><span class="feature-icon"><i class="fas fa-chart-bar"></i></span><div class="feature-content"><h3>Progress Tracking</h3><p>Monitor your overall project completion with a clear progress bar. Stay informed and motivated as you work towards your goals.</p></div></div>
      <div class="feature-item scroll-animate"><span class="feature-icon"><i class="fas fa-palette"></i></span><div class="feature-content"><h3>Customizable Themes</h3><p>Choose between light and dark modes to suit your preference and reduce eye strain, ensuring a comfortable experience day or night.</p></div></div>
      <div class="feature-item scroll-animate"><span class="feature-icon"><i class="fas fa-mobile-alt"></i></span><div class="feature-content"><h3>Responsive Design</h3><p>Access and manage your Stride board seamlessly across all your devices – desktop, tablet, or smartphone. Productivity on the go!</p></div></div>
      <div class="feature-item scroll-animate"><span class="feature-icon"><i class="fas fa-file-export"></i></span><div class="feature-content"><h3>Data Export & Print</h3><p>Easily export your board data as JSON for backups or integration, or print a clean PDF version for offline use and reporting.</p></div></div>
    </div>
  </section>

  <!-- Login View -->
  <section id="login-view" class="w-full view-hidden">
    <div class="auth-top-logo-container">
        <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="auth-top-logo" fill="none">
            <path d="M5 35 L15 25 M15 35 L25 25 M25 35 L35 25" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
    </div>
    <div class="auth-welcome-header">
        <h1>Welcome Back!</h1>
        <p class="text-lg mt-2" style="color: var(--color-text-secondary);">
            Ready to continue your stride?
        </p>
    </div>
    <div class="auth-form-container"> 
        <div class="glass p-7 md:p-10 rounded-xl shadow-lg">
            <h2 class="font-poppins font-semibold" style="color: var(--color-text-primary);">Login to Stride</h2>
            <form id="login-form">
                <input type="email" id="login-email" class="input-field-custom" placeholder="Email Address" required>
                <div class="password-wrapper">
                <input type="password" id="login-password" class="input-field-custom pr-10" placeholder="Password" required>
                <button type="button" class="toggle-password-visibility" data-target="login-password" title="Toggle password visibility"><i class="fas fa-eye"></i></button>
                </div>
                <button type="submit" class="btn btn-primary-accent w-full">
                <i class="fas fa-sign-in-alt mr-2"></i> Login
                </button>
            </form>
            <p id="login-error-message" class="error-message hidden"></p>
            <a href="#" id="forgot-password-link" class="auth-switch-link small-text">Forgot Password?</a>
            <a href="#" id="goto-register-link" class="auth-switch-link">Don't have an account? Register</a>
        </div>
    </div>
  </section>

  <!-- Register View -->
  <section id="register-view" class="w-full view-hidden">
    <div class="auth-top-logo-container">
        <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="auth-top-logo" fill="none">
            <path d="M5 35 L15 25 M15 35 L25 25 M25 35 L35 25" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
    </div>
    <div class="auth-form-container"> 
        <div class="glass p-7 md:p-10 rounded-xl shadow-lg">
            <h2 class="font-poppins font-semibold" style="color: var(--color-text-primary);">Create Stride Account</h2>
            <form id="register-form">
                <input type="email" id="register-email" class="input-field-custom" placeholder="Email Address" required>
                <div class="password-wrapper">
                <input type="password" id="register-password" class="input-field-custom pr-10" placeholder="Password (min. 6 chars)" required>
                <button type="button" class="toggle-password-visibility" data-target="register-password" title="Toggle password visibility"><i class="fas fa-eye"></i></button>
                </div>
                <div class="password-wrapper">
                <input type="password" id="register-confirm-password" class="input-field-custom pr-10" placeholder="Confirm Password" required>
                <button type="button" class="toggle-password-visibility" data-target="register-confirm-password" title="Toggle password visibility"><i class="fas fa-eye"></i></button>
                </div>
                <button type="submit" class="btn btn-primary-accent w-full">
                <i class="fas fa-user-plus mr-2"></i> Register
                </button>
            </form>
            <p id="register-error-message" class="error-message hidden"></p>
            <a href="#" id="goto-login-link" class="auth-switch-link">Already have an account? Login</a>
        </div>
    </div>
  </section>

  <!-- Onboarding View -->
  <section id="onboarding-view" class="w-full text-center view-hidden">
    <header class="onboarding-header text-center w-full max-w-5xl mx-auto">
        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-semibold font-poppins justify-center" style="color: var(--color-text-primary); opacity: 0.9;">
            <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="inline-logo-img mr-2 sm:mr-3" fill="none">
                <path d="M5 35 L15 25 M15 35 L25 25 M25 35 L35 25" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            </svg>
            Welcome to Stride!
        </h2>
        <p class="subtitle mt-3">Let's get you started with the basics.</p>
    </header>
    <div class="onboarding-content glass p-7 md:p-10 rounded-xl shadow-lg w-full max-w-4xl mx-auto">
        <div class="tutorial-grid">
            <div class="tutorial-step feature-item scroll-animate"> 
                <span class="feature-icon"><i class="fas fa-plus-circle"></i></span>
                <div class="feature-content">
                  <h3>Add Tasks</h3>
                  <p>Quickly add new tasks using the input field. Press Ctrl+Enter or click the 'Add Task' button.</p>
                </div>
            </div>
            <div class="tutorial-step feature-item scroll-animate">
                <span class="feature-icon"><i class="fas fa-arrows-alt"></i></span>
                <div class="feature-content">
                  <h3>Drag & Drop</h3>
                  <p>Easily move tasks between 'To Do', 'In Progress', and 'Done' columns to reflect their status.</p>
                </div>
            </div>
             <div class="tutorial-step feature-item scroll-animate">
                <span class="feature-icon"><i class="fas fa-edit"></i></span>
                <div class="feature-content">
                  <h3>Edit Details</h3>
                  <p>Click a task to expand, then use the edit icon to update description, priority, due date, and labels.</p>
                </div>
            </div>
            <div class="tutorial-step feature-item scroll-animate">
                <span class="feature-icon"><i class="fas fa-search"></i></span>
                <div class="feature-content">
                  <h3>Search & Filter</h3>
                  <p>Use the search bar to instantly find tasks by their content or labels. Results update as you type.</p>
                </div>
            </div>
            <div class="tutorial-step feature-item scroll-animate">
                <span class="feature-icon"><i class="fas fa-palette"></i></span>
                <div class="feature-content">
                  <h3>Theme Toggle</h3>
                  <p>Switch between Light and Dark themes using the sun/moon icon for a comfortable viewing experience.</p>
                </div>
            </div>
            <div class="tutorial-step feature-item scroll-animate">
                <span class="feature-icon"><i class="fas fa-chart-pie"></i></span> 
                <div class="feature-content">
                  <h3>Track Progress</h3>
                  <p>Monitor overall completion with the progress bar and view priority distribution in the chart below.</p>
                </div>
            </div>
        </div>
        <div class="onboarding-action mt-10">
            <button id="onboarding-finish-btn" class="btn btn-primary-accent text-lg py-3 px-8">
                <i class="fas fa-rocket mr-2"></i>Get Started with Stride!
            </button>
        </div>
    </div>
  </section>

  <!-- Kanban App View -->
  <section id="kanban-view" class="w-full view-hidden">
    <div id="kanban-view-header" class="hidden"> 
       <span class="app-title"> 
            <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="inline-logo-img mr-2" fill="none">
                <path d="M5 35 L15 25 M15 35 L25 25 M25 35 L35 25" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            </svg>
            Stride Dashboard
        </span>
    </div>
    <section id="add-task-section" class="add-task-section my-12 md:my-16 w-full max-w-xl mx-auto">
      <div class="glass p-7 md:p-10 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold font-poppins mb-6 flex items-center" style="color: var(--color-text-primary);">
          <i class="fas fa-plus-circle mr-3 text-2xl" style="color: var(--color-accent);"></i>
          Add New Task
        </h2>
        <div class="flex flex-col space-y-5">
          <input type="text" id="taskInput" class="input-field-custom" placeholder="What are you working on? (Ctrl+Enter to add)">
          <button id="addTaskBtn" class="btn btn-primary-accent">
            <i class="fas fa-plus mr-2"></i><span class="font-poppins">Add Task</span>
          </button>
        </div>
        <p id="task-error-message" class="error-message hidden mt-5">Oops! Please add a task description.</p>
      </div>
    </section>

    <section id="search-task-container">
        <div class="search-input-wrapper"> 
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="search-task-input" class="input-field-custom" placeholder="Search tasks by text or labels...">
        </div>
    </section>

    <main class="w-full max-w-screen-xl flex-grow mx-auto">
      <div class="kanban-columns-container">
        <div id="todo" class="kanban-column-wrapper">
          <div class="column-header"><h3 class="column-header-title"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75h10.5M9 12h10.5M9 17.25h10.5M3.75 6.75h.007v.008H3.75V6.75zm0 5.25h.007v.008H3.75V12zm0 5.25h.007v.008H3.75V17.25z" /></svg>To Do<span class="task-count" id="todo-count">(0)</span></h3></div>
          <div class="tasks-container space-y-4 flex-grow max-h-[65vh] md:max-h-[70vh] overflow-y-auto pr-2"></div>
        </div>
        <div id="inprogress" class="kanban-column-wrapper">
          <div class="column-header"><h3 class="column-header-title"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>In Progress<span class="task-count" id="inprogress-count">(0)</span></h3></div>
          <div class="tasks-container space-y-4 flex-grow max-h-[65vh] md:max-h-[70vh] overflow-y-auto pr-2"></div>
        </div>
        <div id="done" class="kanban-column-wrapper">
          <div class="column-header"><h3 class="column-header-title"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>Done<span class="task-count" id="done-count">(0)</span></h3></div>
          <div class="tasks-container space-y-4 flex-grow max-h-[65vh] md:max-h-[70vh] overflow-y-auto pr-2"></div>
        </div>
      </div>
    </main>
    <section class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div><span class="progress-text" id="progress-text">0% Complete</span>
      </div>
    </section>

    <section id="charts-section" class="w-full max-w-2xl mx-auto my-8 p-4 md:p-6 glass">
      <h3 class="text-lg font-semibold font-poppins mb-4 text-center" style="color: var(--color-text-primary);">Task Insights</h3>
      <div class="chart-container" style="position: relative; height:auto; max-height:350px; width:100%; max-width:450px; margin: 0 auto;">
        <canvas id="priorityDistributionChart"></canvas>
      </div>
    </section>

    <section class="export-buttons">
      <button id="export-json" class="btn btn-secondary"><i class="fas fa-file-code mr-2"></i>Export as JSON</button>
      <button id="print-board" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Board (Save as PDF)</button>
    </section>
  </section>

  <footer class="global-footer">
    <p>© 2025 Stride Kanban by Redzi Mar Yambao. All rights reserved.</p>
  </footer>

  <script>
    const API_BASE_URL = 'http://127.0.0.1/stride_project/api'; 
    const ONBOARDING_FLAG_KEY = 'stride_onboarding_completed_v1'; 

    const views = {
      landing: document.getElementById('landing-view'),
      login: document.getElementById('login-view'),
      register: document.getElementById('register-view'),
      onboarding: document.getElementById('onboarding-view'),
      kanban: document.getElementById('kanban-view')
    };
    const kanbanViewHeader = document.getElementById('kanban-view-header');
    const logoutBtn = document.getElementById('logout-btn');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');
    const onboardingFinishBtn = document.getElementById('onboarding-finish-btn');

    let taskInput, addTaskBtn, todoColumnTasks, inprogressColumnTasks, doneColumnTasks, columnsTasksContainers, 
        taskErrorMessageElement, progressFill, progressText, exportJsonBtn, printBoardBtn, searchTaskInput;
    
    let loginEmailInput, loginPasswordInput, loginErrorMessage, registerEmailInput, registerPasswordInput, 
        registerConfirmPasswordInput, registerErrorMessage, landingLoginBtn, landingRegisterBtn, 
        gotoRegisterLink, gotoLoginLink, forgotPasswordLink, passwordToggleButtons;

    let lastDragEnd = 0;
    const DRAG_CLICK_THRESHOLD = 100;
    let myPriorityDistributionChart = null;

    const scrollAnimatedElements = document.querySelectorAll('.scroll-animate');
    const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
    const scrollObserver = new IntersectionObserver((entries, observerInstance) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('active');
          observerInstance.unobserve(entry.target);
        }
      });
    }, observerOptions);
    if (scrollAnimatedElements?.length) {
      scrollAnimatedElements.forEach(el => scrollObserver.observe(el));
    }
    
    function triggerScrollAnimations(viewElement) {
        if (!viewElement) return;
        const elementsToAnimate = viewElement.querySelectorAll('.scroll-animate');
        elementsToAnimate.forEach(el => {
            el.classList.remove('active'); 
            setTimeout(() => el.classList.add('active'), 50); 
        });
    }

    function setButtonLoadingState(button, isLoading, loadingText = 'Processing...') {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            if (!button.dataset.originalInnerHTML) button.dataset.originalInnerHTML = button.innerHTML;
            button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ${loadingText}`;
        } else {
            button.disabled = false;
            if (button.dataset.originalInnerHTML) button.innerHTML = button.dataset.originalInnerHTML;
            else if (button.id === 'logout-btn') button.innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i>Logout';
            else if (button.id === 'addTaskBtn') button.innerHTML = '<i class="fas fa-plus mr-2"></i><span class="font-poppins">Add Task</span>';
        }
    }
    
    async function fetchAPI(endpoint, method = 'GET', body = null) {
        const options = { method, credentials: 'include' };
        if (body) {
            options.headers = { 'Content-Type': 'application/json' };
            options.body = JSON.stringify(body);
        }
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            const contentType = response.headers.get("content-type");
            let data;

            if (contentType && contentType.includes("application/json")) {
                data = await response.json();
            } else {
                data = await response.text();
            }
            
            if (!response.ok) {
                const errorMessage = (typeof data === 'object' && data.error) ? data.error : (data || `HTTP error! Status: ${response.status}`);
                console.error(`API Error (${response.status}) for ${method} ${endpoint}:`, errorMessage, data);
                throw { status: response.status, message: errorMessage, data };
            }
            return { data, responseOk: response.ok, status: response.status }; 
        } catch (error) {
            console.error(`Network or Fetch Error for ${method} ${endpoint}:`, error);
            const message = error.message || "A network error occurred. Please try again.";
            throw { ...error, message };
        }
    }


    function navigateTo(viewName) {
      Object.values(views).forEach(view => view?.classList.add('view-hidden'));
      if (views[viewName]) {
        views[viewName].classList.remove('view-hidden');
        window.scrollTo({ top: 0, behavior: 'auto' });
        
        const isUserSessionActiveView = viewName === 'kanban' || viewName === 'onboarding';
        kanbanViewHeader?.classList.toggle('hidden', !isUserSessionActiveView); 
        logoutBtn?.classList.toggle('view-hidden', !isUserSessionActiveView); 

        if (viewName === 'kanban') {
          initializeKanbanDOM(); 
          loadTasksFromServer();
        } else if (viewName === 'landing' && views.landing) {
           triggerScrollAnimations(views.landing);
        } else if (viewName === 'onboarding' && views.onboarding) {
            triggerScrollAnimations(views.onboarding); 
        }

      } else {
        views.landing?.classList.remove('view-hidden'); 
        console.error("View not found: ", viewName);
      }
    }
    
    function initializeAuthDOM() {
        loginEmailInput = document.getElementById('login-email');
        loginPasswordInput = document.getElementById('login-password');
        loginErrorMessage = document.getElementById('login-error-message');
        registerEmailInput = document.getElementById('register-email');
        registerPasswordInput = document.getElementById('register-password');
        registerConfirmPasswordInput = document.getElementById('register-confirm-password');
        registerErrorMessage = document.getElementById('register-error-message');
        landingLoginBtn = document.getElementById('landing-login-btn');
        landingRegisterBtn = document.getElementById('landing-register-btn');
        gotoRegisterLink = document.getElementById('goto-register-link');
        gotoLoginLink = document.getElementById('goto-login-link');
        forgotPasswordLink = document.getElementById('forgot-password-link');
        passwordToggleButtons = document.querySelectorAll('.toggle-password-visibility');
    }

    async function handleRegister(event) {
      event.preventDefault();
      const registerButton = registerForm.querySelector('button[type="submit"]');
      setButtonLoadingState(registerButton, true, 'Registering...');
      registerErrorMessage?.classList.add('hidden');
      
      const email = registerEmailInput.value.trim();
      const password = registerPasswordInput.value;
      const confirmPassword = registerConfirmPasswordInput.value;

      if (!email || !password || !confirmPassword) { showAuthError(registerErrorMessage, "All fields are required."); setButtonLoadingState(registerButton, false); return; }
      if (password !== confirmPassword) { showAuthError(registerErrorMessage, "Passwords do not match."); setButtonLoadingState(registerButton, false); return; }
      if (password.length < 6) { showAuthError(registerErrorMessage, "Password must be at least 6 characters."); setButtonLoadingState(registerButton, false); return; }

      try {
        const { data, responseOk } = await fetchAPI('/register.php', 'POST', { email, password });
        if (responseOk && data.success) {
          localStorage.removeItem(ONBOARDING_FLAG_KEY); 
          navigateTo('onboarding'); 
          registerForm.reset();
        } else { showAuthError(registerErrorMessage, data.error || "Registration failed."); }
      } catch (error) { showAuthError(registerErrorMessage, error.message || "An error occurred."); }
      finally { setButtonLoadingState(registerButton, false); }
    }

    async function handleLogin(event) {
      event.preventDefault();
      const loginButton = loginForm.querySelector('button[type="submit"]');
      setButtonLoadingState(loginButton, true, 'Logging in...');
      loginErrorMessage?.classList.add('hidden');

      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value;
      if (!email || !password) { showAuthError(loginErrorMessage, "Email and password are required."); setButtonLoadingState(loginButton, false); return; }

      try {
        const { data, responseOk } = await fetchAPI('/login.php', 'POST', { email, password });
        if (responseOk && data.success) {
          navigateTo('kanban'); 
          loginForm.reset();
        } else { showAuthError(loginErrorMessage, data.error || "Login failed."); }
      } catch (error) { showAuthError(loginErrorMessage, error.message || "An error occurred."); }
      finally { setButtonLoadingState(loginButton, false); }
    }

    async function handleLogout() {
      if (!logoutBtn) return;
      setButtonLoadingState(logoutBtn, true, 'Logging out...');
      try {
        const { data, responseOk } = await fetchAPI('/logout.php', 'POST');
        if (responseOk && data.success) navigateTo('login');
        else alert("Logout failed: " + (data.error || "Please try again."));
      } catch (error) { alert("An error occurred during logout: " + error.message); }
      finally { setButtonLoadingState(logoutBtn, false); }
    }

    async function checkLoginStatus() {
      try {
        const { data } = await fetchAPI('/check_session.php');
        if (data.loggedIn) {
            if (localStorage.getItem(ONBOARDING_FLAG_KEY) !== 'true') {
                 navigateTo('onboarding'); 
            } else {
                 navigateTo('kanban');
            }
        } else {
            navigateTo('landing');
        }
      } catch (error) { navigateTo('landing'); }
    }
    function showAuthError(el, msg) { if (el) { el.textContent = msg; el.classList.remove('hidden'); } }

    function initializeKanbanDOM() {
      taskInput = document.getElementById('taskInput');
      addTaskBtn = document.getElementById('addTaskBtn');
      todoColumnTasks = document.getElementById('todo')?.querySelector('.tasks-container');
      inprogressColumnTasks = document.getElementById('inprogress')?.querySelector('.tasks-container');
      doneColumnTasks = document.getElementById('done')?.querySelector('.tasks-container');
      columnsTasksContainers = document.querySelectorAll('#kanban-view .tasks-container');
      taskErrorMessageElement = document.getElementById('task-error-message');
      progressFill = document.getElementById('progress-fill');
      progressText = document.getElementById('progress-text');
      exportJsonBtn = document.getElementById('export-json');
      printBoardBtn = document.getElementById('print-board');
      searchTaskInput = document.getElementById('search-task-input'); 

      addTaskBtn?.removeEventListener('click', addTask); addTaskBtn?.addEventListener('click', addTask);
      taskInput?.removeEventListener('keypress', handleTaskInputKeypress); taskInput?.addEventListener('keypress', handleTaskInputKeypress);
      taskInput?.removeEventListener('input', handleTaskInput); taskInput?.addEventListener('input', handleTaskInput);
      
      columnsTasksContainers?.forEach(container => {
        container.removeEventListener('dragover', handleDragOver); container.addEventListener('dragover', handleDragOver);
        container.removeEventListener('dragleave', handleDragLeave); container.addEventListener('dragleave', handleDragLeave);
        container.removeEventListener('drop', handleDrop); container.addEventListener('drop', handleDrop);
        container.removeEventListener('click', handleTaskActionDelegation);
        container.addEventListener('click', handleTaskActionDelegation);
      });
      exportJsonBtn?.removeEventListener('click', exportBoardAsJson); exportJsonBtn?.addEventListener('click', exportBoardAsJson);
      printBoardBtn?.removeEventListener('click', printBoard); printBoardBtn?.addEventListener('click', printBoard);
      searchTaskInput?.removeEventListener('input', filterTasks); searchTaskInput?.addEventListener('input', filterTasks);
    }
    
    function handleTaskInputKeypress(event) { if (event.key === 'Enter' && event.ctrlKey) { event.preventDefault(); addTask(); } }
    function handleTaskInput() { if (taskInput?.value.trim()) taskErrorMessageElement?.classList.add('hidden'); }

    function formatDate(date) { if (!date) return ''; if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) return date; const d = new Date(date); return isNaN(d.getTime()) ? '' : `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`; }
    function getDaysRemaining(dueDate) { if (!dueDate) return null; const today = new Date(); today.setHours(0,0,0,0); const [y,m,d] = dueDate.split('-').map(Number); const due = new Date(Date.UTC(y,m-1,d)); return Math.ceil((due - today) / (1000*60*60*24)); }
    function getDueDateDisplay(dueDate) {
        if (!dueDate) return { text: '', class: '', iconClass: '' };
        const days = getDaysRemaining(dueDate);
        if (days < 0) return { text: `Overdue by ${Math.abs(days)} day${Math.abs(days)>1?'s':''}`, class: 'overdue-text', iconClass: 'fas fa-exclamation-circle' };
        if (days === 0) return { text: 'Due Today', class: 'upcoming-text', iconClass: 'fas fa-clock' };
        if (days === 1) return { text: 'Due Tomorrow', class: 'upcoming-text', iconClass: 'fas fa-clock' };
        if (days <= 7) return { text: `Due in ${days} days`, class: 'upcoming-text', iconClass: '' };
        const [y,m,d] = dueDate.split('-').map(Number);
        return { text: `Due ${new Date(y,m-1,d).toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'})}`, class: 'normal-date-text', iconClass: '' };
    }

    function createTaskCard({ id, text, priority = 'low', due_date = '', labels = '', column_id = 'todo', sort_order = 0 }) {
      const taskCard = document.createElement('div');
      taskCard.id = String(id);
      taskCard.className = `task-card priority-${priority}`;
      taskCard.draggable = true;
      taskCard.dataset.column = column_id;
      taskCard.dataset.priority = priority;
      const displayDueDate = due_date ? formatDate(new Date(due_date)) : '';
      taskCard.dataset.duedate = displayDueDate;
      taskCard.dataset.labels = labels || '';
      taskCard.dataset.sortOrder = sort_order;

      const dueDateInfo = getDueDateDisplay(displayDueDate);
      const labelTagsHtml = (labels || '').split(',').map(l => l.trim()).filter(l => l)
                            .map(tag => `<span class="task-label-badge">${tag}</span>`).join('') || 'No labels';
      
      taskCard.innerHTML = `
        <div class="task-content-view">
          <p class="task-description">${text}</p>
          <div class="task-meta">
            <span><i class="fas fa-flag"></i> Priority: <strong class="priority-${priority}-text">${priority.charAt(0).toUpperCase() + priority.slice(1)}</strong></span>
            <span class="${dueDateInfo.class}"><i class="fas fa-calendar-alt"></i> ${dueDateInfo.iconClass ? `<i class="${dueDateInfo.iconClass} mr-1"></i>` : ''}${dueDateInfo.text || 'Not set'}</span>
            <span class="task-labels-container"><i class="fas fa-tags"></i> ${labelTagsHtml}</span>
          </div>
        </div>
        <div class="edit-form">
          <textarea class="edit-text">${text}</textarea>
          <div><label for="edit-priority-${id}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority:</label>
            <select class="edit-priority input-field-custom" id="edit-priority-${id}">
              <option value="low" ${priority === 'low' ? 'selected' : ''}>Low</option>
              <option value="medium" ${priority === 'medium' ? 'selected' : ''}>Medium</option>
              <option value="high" ${priority === 'high' ? 'selected' : ''}>High</option>
            </select>
          </div>
          <div><label for="edit-duedate-${id}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Due Date:</label>
            <input type="date" class="edit-duedate input-field-custom" id="edit-duedate-${id}" value="${displayDueDate}">
          </div>
          <div><label for="edit-labels-${id}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Labels (comma-sep):</label>
            <input type="text" class="edit-labels input-field-custom" placeholder="e.g., Bug, Feature" id="edit-labels-${id}" value="${labels || ''}">
          </div>
          <div class="edit-buttons">
            <button class="task-card-action-btn save-btn bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)]"><i class="fas fa-check mr-1"></i> Save</button>
            <button class="task-card-action-btn cancel-btn bg-[var(--color-text-muted)] hover:bg-[var(--color-text-secondary)]"><i class="fas fa-times mr-1"></i> Cancel</button>
          </div>
        </div>
        <div class="task-actions">
          <button class="delete-btn" title="Delete task"><i class="fas fa-trash-alt"></i></button>
          <button class="edit-btn" title="Edit task"><i class="fas fa-edit"></i></button>
        </div>`;
      taskCard.addEventListener('dragstart', handleDragStart);
      taskCard.addEventListener('dragend', handleDragEnd);
      return taskCard;
    }
    
    async function handleTaskActionDelegation(event) {
        const taskCard = event.target.closest('.task-card');
        if (!taskCard) return;

        const isDeleteBtn = event.target.closest('.delete-btn');
        const isEditBtn = event.target.closest('.edit-btn');
        const isSaveBtn = event.target.closest('.save-btn');
        const isCancelBtn = event.target.closest('.cancel-btn');

        if (isDeleteBtn) {
            event.stopPropagation();
            const textElement = taskCard.querySelector('.task-description');
            const taskTextPreview = textElement.textContent.substring(0,50) + (textElement.textContent.length > 50 ? "..." : "");
            if (confirm(`Are you sure you want to delete task: "${taskTextPreview}"?`)) {
                try {
                    const { data, responseOk } = await fetchAPI(`/tasks_api.php?id=${taskCard.id}`, 'DELETE');
                    if (responseOk && data.success) {
                        taskCard.classList.add('removing');
                        taskCard.addEventListener('animationend', () => { taskCard.remove(); updateProgressStats(); filterTasks(); }, { once: true });
                    } else alert("Failed to delete task: " + (data.error || "Server error."));
                } catch (error) { alert("Error deleting task: " + error.message); }
            }
        } else if (isEditBtn) {
            event.stopPropagation();
            taskCard.classList.add('editing');
            const editForm = taskCard.querySelector('.edit-form');
            editForm.querySelector('.edit-text').focus();
        } else if (isSaveBtn) {
            event.stopPropagation();
            const editForm = taskCard.querySelector('.edit-form');
            await handleSaveTaskEdit(taskCard, editForm, isSaveBtn);
        } else if (isCancelBtn) {
            event.stopPropagation();
            taskCard.classList.remove('editing');
        } else if (!event.target.closest('.task-actions') && !taskCard.classList.contains('editing')) {
            if (Date.now() - lastDragEnd < DRAG_CLICK_THRESHOLD) return;
            taskCard.classList.toggle('expanded');
        }
    }
    
    async function handleSaveTaskEdit(taskCard, editForm, saveEditButton) {
        setButtonLoadingState(saveEditButton, true, 'Saving...');
        const newText = editForm.querySelector('.edit-text').value.trim();
        const newPriority = editForm.querySelector('.edit-priority').value;
        const newDueDateRaw = editForm.querySelector('.edit-duedate').value;
        const newLabels = editForm.querySelector('.edit-labels').value.trim();

        if (!newText) { alert("Task description cannot be empty!"); editForm.querySelector('.edit-text').focus(); setButtonLoadingState(saveEditButton, false); return; }
        
        const updatedTaskData = { id: taskCard.id, text: newText, priority: newPriority, dueDate: newDueDateRaw || null, labels: newLabels };
        try {
            const { data, responseOk } = await fetchAPI('/tasks_api.php', 'PUT', updatedTaskData);
            if (responseOk && data.success) {
                taskCard.querySelector('.task-description').textContent = newText;
                taskCard.classList.remove('priority-low', 'priority-medium', 'priority-high');
                taskCard.classList.add(`priority-${newPriority}`);
                taskCard.querySelector('.task-meta .priority-${newPriority}-text').parentElement.innerHTML = `<i class="fas fa-flag"></i> Priority: <strong class="priority-${newPriority}-text">${newPriority.charAt(0).toUpperCase() + newPriority.slice(1)}</strong>`;
                
                const dueDateInfo = getDueDateDisplay(newDueDateRaw);
                const dueDateElement = taskCard.querySelector('.task-meta span:nth-child(2)'); 
                dueDateElement.className = dueDateInfo.class;
                dueDateElement.innerHTML = `<i class="fas fa-calendar-alt"></i> ${dueDateInfo.iconClass ? `<i class="${dueDateInfo.iconClass} mr-1"></i>`:''}${dueDateInfo.text || 'Not set'}`;
                
                const labelsContainer = taskCard.querySelector('.task-meta .task-labels-container');
                labelsContainer.innerHTML = `<i class="fas fa-tags"></i> ` + (newLabels.split(',').map(l=>l.trim()).filter(l=>l).map(tag => `<span class="task-label-badge">${tag}</span>`).join('') || 'No labels');

                taskCard.dataset.priority = newPriority;
                taskCard.dataset.duedate = newDueDateRaw || '';
                taskCard.dataset.labels = newLabels;
                taskCard.classList.remove('editing');
                if (!taskCard.classList.contains('expanded')) taskCard.classList.add('expanded');
                updateProgressStats(); filterTasks();
            } else alert("Failed to update task: " + (data.error || "Server error."));
        } catch (error) { alert("Error updating task: " + error.message); }
        finally { setButtonLoadingState(saveEditButton, false); }
    }


    async function addTask() { 
      if (!taskInput?.value.trim()) {
        taskErrorMessageElement?.classList.remove('hidden');
        taskInput?.focus();
        return;
      }
      taskErrorMessageElement?.classList.add('hidden');
      setButtonLoadingState(addTaskBtn, true, 'Adding...');
      try {
        const { data, responseOk } = await fetchAPI('/tasks_api.php', 'POST', {
          text: taskInput.value.trim(), priority: 'low', dueDate: null, labels: '', columnId: 'todo'
        });
        if (responseOk && data.success && data.task) {
          todoColumnTasks?.appendChild(createTaskCard(data.task));
          taskInput.value = '';
          updateProgressStats(); filterTasks();
        } else alert("Failed to add task: " + (data.error || "Server error"));
      } catch (error) { alert("Error adding task: " + error.message); }
      finally { setButtonLoadingState(addTaskBtn, false); }
    }

    let draggedElement = null;
    function handleDragStart(event) { if (event.target.classList.contains('editing')) { event.preventDefault(); return; } event.target.classList.remove('expanded'); draggedElement = event.target; event.dataTransfer.setData('text/plain', event.target.id); event.dataTransfer.effectAllowed = 'move'; setTimeout(() => draggedElement?.classList.add('dragging'), 0); }
    function handleDragEnd() { draggedElement?.classList.remove('dragging'); draggedElement = null; lastDragEnd = Date.now(); columnsTasksContainers?.forEach(c => c.classList.remove('drag-over')); }
    function handleDragOver(event) { event.preventDefault(); event.dataTransfer.dropEffect = 'move'; event.target.closest('.tasks-container')?.classList.add('drag-over'); }
    function handleDragLeave(event) { const tc=event.target.closest('.tasks-container'); if(tc){ const r=tc.getBoundingClientRect(); if(event.clientX<r.left||event.clientX>=r.right||event.clientY<r.top||event.clientY>=r.bottom) tc.classList.remove('drag-over'); } }

    async function handleDrop(event) {
      event.preventDefault();
      columnsTasksContainers?.forEach(c => c.classList.remove('drag-over'));
      const id = event.dataTransfer.getData('text/plain');
      const draggableEl = document.getElementById(id);
      const targetDropZone = event.target.closest('.tasks-container');

      if (draggableEl && targetDropZone) {
        const originalColumnId = draggableEl.dataset.column;
        const targetColumnId = targetDropZone.parentElement.id;
        let beforeElement = Array.from(targetDropZone.querySelectorAll('.task-card:not(.dragging)')).find(c => event.clientY < c.getBoundingClientRect().top + c.offsetHeight / 2);
        targetDropZone.insertBefore(draggableEl, beforeElement);
        draggableEl.dataset.column = targetColumnId;
        
        const tasksToUpdatePayload = [];
        Array.from(targetDropZone.querySelectorAll('.task-card')).forEach((c,i) => tasksToUpdatePayload.push({id:c.id, column_id:targetColumnId, sort_order:i}));
        if(originalColumnId && originalColumnId !== targetColumnId && draggableEl.parentElement.previousSibling?.classList.contains('tasks-container')){ 
            Array.from(draggableEl.parentElement.previousSibling.querySelectorAll('.task-card')).forEach((c,i) => {
                if(!tasksToUpdatePayload.find(t => t.id === c.id)) tasksToUpdatePayload.push({id:c.id, column_id:originalColumnId, sort_order:i});
            });
        }
        
        const uniqueTasksToUpdate = Array.from(new Map(tasksToUpdatePayload.map(task => [task.id, task])).values());
        if (uniqueTasksToUpdate.length > 0) {
            try {
                for (const taskData of uniqueTasksToUpdate) {
                    const { data, responseOk } = await fetchAPI('/tasks_api.php', 'PUT', taskData);
                    if (!responseOk || !data.success) throw new Error(data.error || "Server error during batch update.");
                }
                await loadTasksFromServer(); 
            } catch (error) {
                console.error('Error batch updating tasks:', error.message);
                await loadTasksFromServer(); 
            }
        } else { updateProgressStats(); filterTasks(); }
      }
    }

    function updateColumnVisuals() {
        const columnsMeta = [
            { id: 'todo', container: todoColumnTasks, countEl: document.getElementById('todo-count') },
            { id: 'inprogress', container: inprogressColumnTasks, countEl: document.getElementById('inprogress-count') },
            { id: 'done', container: doneColumnTasks, countEl: document.getElementById('done-count') }
        ];
        columnsMeta.forEach(({ container, countEl }) => {
            if (!container || !countEl) return;
            const visibleTasks = Array.from(container.children).filter(c => c.classList.contains('task-card') && !c.classList.contains('hidden-by-filter'));
            countEl.textContent = `(${visibleTasks.length})`;
            let msgEl = container.querySelector('.empty-column-message');
            if (visibleTasks.length === 0) {
                if (!msgEl) {
                    msgEl = document.createElement('div');
                    msgEl.className = 'empty-column-message text-center p-4 flex flex-col items-center justify-center absolute inset-0';
                    msgEl.style.cssText = 'color: var(--color-text-muted); font-style: italic; min-height: 150px;';
                    msgEl.innerHTML = '<i class="fas fa-folder-open fa-3x mb-3 opacity-50"></i><p>Nothing to see here!</p>';
                    container.appendChild(msgEl);
                }
                msgEl.style.display = 'flex';
            } else if (msgEl) msgEl.style.display = 'none';
        });
    }

    async function loadTasksFromServer() {
      if (views.kanban.classList.contains('view-hidden') || !columnsTasksContainers) return;
      try {
        const { data: tasksByColumn, responseOk, status } = await fetchAPI('/tasks_api.php'); 
        if (!responseOk) { if (status === 401) navigateTo('login'); return; }

        columnsTasksContainers.forEach(container => container.innerHTML = '');

        if (!tasksByColumn || typeof tasksByColumn !== 'object') return;
        Object.entries(tasksByColumn).forEach(([columnKey, tasks]) => {
          const columnEl = document.getElementById(columnKey)?.querySelector('.tasks-container');
          if (columnEl && Array.isArray(tasks)) {
            tasks.sort((a, b) => (Number(a.sort_order) || 0) - (Number(b.sort_order) || 0))
                 .forEach(taskData => {
                     try { columnEl.appendChild(createTaskCard(taskData)); }
                     catch (e) { console.error("Error creating/appending card:", e, taskData); }
                 });
          }
        });
        filterTasks(); updateProgressStats(); 
      } catch (error) { console.error("Error loading tasks:", error.message); }
    }
    
    let RcsCache = {}; 
    function getRootCssVariable(varName) { return RcsCache[varName] || (RcsCache[varName] = getComputedStyle(document.documentElement).getPropertyValue(varName).trim()); }
    function clearRootCssCache() { RcsCache = {}; }


    function renderOrUpdatePriorityDistributionChart() {
        const chartCanvas = document.getElementById('priorityDistributionChart');
        if (!chartCanvas || !columnsTasksContainers?.length) return;
        const ctx = chartCanvas.getContext('2d'); if (!ctx) return;

        let allVisibleTasks = [];
        columnsTasksContainers.forEach(cont => allVisibleTasks.push(...Array.from(cont.querySelectorAll('.task-card:not(.hidden-by-filter)'))));
        
        const priorityCounts = allVisibleTasks.reduce((acc, task) => { acc[task.dataset.priority]++; return acc; }, {low:0, medium:0, high:0});
        const chartDataValues = [priorityCounts.low, priorityCounts.medium, priorityCounts.high];
        const totalTasksForChart = chartDataValues.reduce((a,b) => a+b, 0);
        
        const chartSection = document.getElementById('charts-section');
        if (totalTasksForChart === 0) {
            if (myPriorityDistributionChart) { myPriorityDistributionChart.destroy(); myPriorityDistributionChart = null; }
            if(chartSection) chartSection.style.display = 'none'; return;
        } else if(chartSection) chartSection.style.display = 'block';

        const isDarkMode = document.body.classList.contains('dark-mode');
        const colors = {
            primary: getRootCssVariable('--color-text-primary'),
            secondary: getRootCssVariable('--color-text-secondary'),
            low: getRootCssVariable('--color-priority-low'),
            medium: getRootCssVariable('--color-priority-medium'),
            high: getRootCssVariable('--color-priority-high'),
            border: getRootCssVariable(isDarkMode ? '--color-bg-page-start' : '--color-card-bg'),
            hoverBorder: isDarkMode ? '#FFFFFF' : '#333333'
        };
        const segmentColors = [colors.low, colors.medium, colors.high];
        const segmentHoverColors = segmentColors.map(c => Chart.helpers.color(c).darken(0.1).rgbString());

        const chartConfig = {
            type: 'doughnut',
            data: {
                labels: ['Low', 'Medium', 'High Priority'],
                datasets: [{ data: chartDataValues, backgroundColor: segmentColors, hoverBackgroundColor: segmentHoverColors, borderColor: colors.border, borderWidth: 2, hoverBorderColor: colors.hoverBorder }]
            },
            options: {
                responsive: true, maintainAspectRatio: true, cutout: '60%',
                plugins: {
                    title: { display: true, text: 'Task Priority Distribution', color: colors.primary, font: {size:16, family:"'Poppins',sans-serif"}, padding:{bottom:15} },
                    legend: { position: 'bottom', labels: { color: colors.secondary, font: {family:"'Inter',sans-serif"}, padding:15 } },
                    tooltip: { titleFont:{family:"'Poppins',sans-serif"}, bodyFont:{family:"'Inter',sans-serif"}, callbacks: {
                        label: ctx => `${ctx.label || ''}: ${ctx.parsed} (${totalTasksForChart > 0 ? (ctx.parsed/totalTasksForChart*100).toFixed(1):0}%)`
                    }}
                }
            }
        };

        if (myPriorityDistributionChart) { Object.assign(myPriorityDistributionChart.data.datasets[0], chartConfig.data.datasets[0]); Object.assign(myPriorityDistributionChart.options.plugins.title, chartConfig.options.plugins.title); Object.assign(myPriorityDistributionChart.options.plugins.legend.labels, chartConfig.options.plugins.legend.labels); myPriorityDistributionChart.update(); }
        else { myPriorityDistributionChart = new Chart(ctx, chartConfig); }
    }


    function setTheme(theme) { 
        clearRootCssCache();
        document.body.classList.toggle('dark-mode', theme === 'dark'); 
        sunIcon?.classList.toggle('hidden', theme === 'dark'); 
        moonIcon?.classList.toggle('hidden', theme === 'light'); 
        localStorage.setItem('strideKanbanTheme', theme); 
        if (!views.kanban.classList.contains('view-hidden')) renderOrUpdatePriorityDistributionChart();
    }
    function loadThemePreference() { const savedTheme = localStorage.getItem('strideKanbanTheme') || (window.matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); setTheme(savedTheme); }

    function updateProgressStats() { 
        if (!progressFill || !progressText) return; 
        updateColumnVisuals(); 
        const counts = ['todo', 'inprogress', 'done'].map(id => document.querySelectorAll(`#${id} .task-card:not(.hidden-by-filter)`).length);
        const totalVisible = counts.reduce((a,b) => a+b, 0);
        const progress = totalVisible > 0 ? (counts[2] / totalVisible) * 100 : 0; 
        progressFill.style.width = `${progress}%`; 
        progressText.textContent = `${Math.round(progress)}% Complete (Visible)`; 
        renderOrUpdatePriorityDistributionChart();
    }

    async function exportBoardAsJson() {
      try {
        const { data: dataToExport, responseOk } = await fetchAPI('/tasks_api.php');
        if (!responseOk || Object.values(dataToExport).every(col => col.length === 0)) { alert("No tasks to export!"); return; }
        const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), { href:url, download:`stride_kanban_export_${formatDate(new Date()).replace(/-/g,'')}.json`});
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      } catch (e) { alert("Could not export tasks: " + e.message); }
    }
    function printBoard() { window.print(); }

    function filterTasks() {
        if (!searchTaskInput || !columnsTasksContainers) return;
        const searchTerm = searchTaskInput.value.toLowerCase().trim();
        columnsTasksContainers.forEach(container => {
            container.querySelectorAll('.task-card').forEach(card => {
                const text = card.querySelector('.task-description')?.textContent.toLowerCase() || '';
                const labels = card.dataset.labels?.toLowerCase() || '';
                card.classList.toggle('hidden-by-filter', !(text.includes(searchTerm) || labels.includes(searchTerm)));
            });
        });
        updateProgressStats(); 
    }

    function initEventListeners() {
      initializeAuthDOM(); 

      landingLoginBtn?.addEventListener('click', () => navigateTo('login'));
      landingRegisterBtn?.addEventListener('click', () => navigateTo('register'));
      gotoRegisterLink?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('register'); });
      gotoLoginLink?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('login'); });
      forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); alert("Forgot password functionality not implemented."); });
      
      loginForm?.addEventListener('submit', handleLogin);
      registerForm?.addEventListener('submit', handleRegister);
      logoutBtn?.addEventListener('click', handleLogout);
      themeToggleBtn?.addEventListener('click', () => setTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark'));
      
      onboardingFinishBtn?.addEventListener('click', () => {
        localStorage.setItem(ONBOARDING_FLAG_KEY, 'true');
        navigateTo('kanban');
      });

      window.matchMedia?.('(prefers-color-scheme: dark)')
            .addEventListener('change', e => { if (!localStorage.getItem('strideKanbanTheme')) setTheme(e.matches ? 'dark' : 'light'); });

      passwordToggleButtons?.forEach(button => {
        button.addEventListener('click', function() {
          const targetInput = document.getElementById(this.dataset.target);
          const icon = this.querySelector('i');
          if (targetInput && icon) {
            const isPassword = targetInput.type === 'password';
            targetInput.type = isPassword ? 'text' : 'password';
            icon.classList.toggle('fa-eye', !isPassword);
            icon.classList.toggle('fa-eye-slash', isPassword);
          }
        });
      });

      [loginEmailInput, loginPasswordInput].forEach(el => el?.addEventListener('input', () => loginErrorMessage?.classList.add('hidden')));
      [registerEmailInput, registerPasswordInput, registerConfirmPasswordInput].forEach(el => el?.addEventListener('input', () => registerErrorMessage?.classList.add('hidden')));

      document.addEventListener('keydown', (event) => {
        if (event.altKey && (event.key === 'n' || event.key === 'N') && !views.kanban.classList.contains('view-hidden')) { 
          event.preventDefault(); taskInput?.focus();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadThemePreference();
      initEventListeners();
      checkLoginStatus();
    });
  </script>
</body>
</html>